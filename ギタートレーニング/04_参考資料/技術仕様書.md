# ギタートレーニングアプリ 技術仕様書

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────┐
│   Web Client    │  (Next.js - React)
│   (Browser)     │
└────────┬────────┘
         │
         │ HTTPS/REST API
         │
┌────────▼────────┐
│  Next.js API    │  (Server-side)
│  Routes/Express  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│PostgreSQL│ │  Redis  │
│(Primary) │ │(Cache)  │
└─────────┘ └─────────┘

┌─────────────────┐
│ Mobile Client   │  (React Native)
│ iOS/Android     │
└────────┬────────┘
         │
         │ HTTPS/REST API
         │
         │ (Same Backend)
```

### 1.2 技術スタック詳細

#### フロントエンド（Web）
- **Framework**: Next.js 14+ (App Router)
- **Language**: TypeScript 5+
- **Styling**: Tailwind CSS 3+
- **UI Components**: shadcn/ui
- **State Management**: Zustand
- **Form Handling**: React Hook Form + Zod
- **Audio Processing**: Tone.js
- **Music Notation**: VexFlow
- **Charts**: Recharts
- **Video**: Video.js または react-player

#### バックエンド
- **Runtime**: Node.js 18+
- **Framework**: Next.js API Routes（または Express.js）
- **Language**: TypeScript
- **Database**: PostgreSQL 14+
- **ORM**: Prisma
- **Cache**: Redis 6+
- **File Storage**: AWS S3 または Cloudinary
- **Authentication**: NextAuth.js v5
- **Validation**: Zod

#### モバイル
- **Framework**: React Native 0.72+
- **Language**: TypeScript
- **Navigation**: React Navigation 6+
- **State**: Zustand（Webと共有）
- **Audio**: 
  - react-native-sound（再生）
  - react-native-audio（録音・解析）
- **Storage**: 
  - AsyncStorage（キー・バリュー）
  - SQLite（オフラインデータ）

---

## 2. データベース設計

### 2.1 ER図（主要エンティティ）

```
User ──┬── UserProgress ─── Lesson
       │
       ├── PracticeLog
       │
       ├── UserGoal
       │
       └── UserSubscription

Lesson ──┬── LessonContent
         │
         └── LessonExercise

Song ────┬── SongTab
         │
         └── SongAudio

Scale
Chord
ChordProgression
```

### 2.2 データモデル（Prisma Schema）

```prisma
// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String          @id @default(cuid())
  email             String          @unique
  name              String?
  passwordHash      String?
  image             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  progress          UserProgress[]
  practiceLogs     PracticeLog[]
  goals            UserGoal[]
  subscription     UserSubscription?
  
  @@map("users")
}

model Lesson {
  id                String          @id @default(cuid())
  title             String
  description       String?
  level             Int             // 1: 基礎, 2: 中級, 3: 上級
  order             Int             // レッスン順序
  estimatedDuration Int             // 分単位
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  contents          LessonContent[]
  exercises         LessonExercise[]
  userProgress      UserProgress[]
  
  @@map("lessons")
}

model LessonContent {
  id                String          @id @default(cuid())
  lessonId          String
  type              String          // "text", "image", "video", "tab"
  content           String          // JSON or text
  order             Int
  createdAt         DateTime        @default(now())
  
  lesson            Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@map("lesson_contents")
}

model UserProgress {
  id                String          @id @default(cuid())
  userId            String
  lessonId          String
  completed         Boolean         @default(false)
  completedAt       DateTime?
  score             Int?            // 0-100
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson            Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@map("user_progress")
}

model PracticeLog {
  id                String          @id @default(cuid())
  userId            String
  date              DateTime        @default(now())
  duration          Int             // 分単位
  content           String?         // 練習内容
  notes             String?
  attachments       String[]        // 画像・動画URL
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("practice_logs")
}

model Song {
  id                String          @id @default(cuid())
  title             String
  artist            String?
  difficulty        Int             // 1-5
  style             String          // "rock", "jazz", "blues", etc.
  key               String?         // "C", "Am", etc.
  tempo             Int?            // BPM
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  tabs              SongTab[]
  audio             SongAudio[]
  
  @@map("songs")
}

model SongTab {
  id                String          @id @default(cuid())
  songId            String
  format            String          // "guitar_pro", "text", "vexflow"
  content           String          // Tab content (JSON or text)
  createdAt         DateTime        @default(now())
  
  song              Song            @relation(fields: [songId], references: [id], onDelete: Cascade)
  
  @@map("song_tabs")
}

model Scale {
  id                String          @id @default(cuid())
  name              String          // "Major", "Minor", "Pentatonic"
  type              String          // "major", "minor", "pentatonic", "mode"
  intervals         Int[]           // [0, 2, 4, 5, 7, 9, 11] for major
  description       String?
  
  @@unique([name, type])
  @@map("scales")
}

model Chord {
  id                String          @id @default(cuid())
  name              String          // "C", "Am", "F#m7b5"
  type              String          // "major", "minor", "dominant", etc.
  intervals         Int[]           // [0, 4, 7] for major triad
  fingering         Json?           // Fret positions
  description       String?
  
  @@unique([name, type])
  @@map("chords")
}

model UserGoal {
  id                String          @id @default(cuid())
  userId            String
  title             String
  description       String?
  targetDate        DateTime?
  completed         Boolean         @default(false)
  completedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_goals")
}

model UserSubscription {
  id                String          @id @default(cuid())
  userId            String          @unique
  plan              String          // "free", "premium", "pro"
  status            String          // "active", "canceled", "expired"
  startDate         DateTime        @default(now())
  endDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_subscriptions")
}
```

---

## 3. API設計

### 3.1 認証エンドポイント

```
POST   /api/auth/register      - ユーザー登録
POST   /api/auth/login         - ログイン
POST   /api/auth/logout        - ログアウト
GET    /api/auth/me            - 現在のユーザー情報
PUT    /api/auth/profile       - プロフィール更新
```

### 3.2 レッスンエンドポイント

```
GET    /api/lessons            - レッスン一覧（フィルター、ページネーション）
GET    /api/lessons/:id        - レッスン詳細
GET    /api/lessons/:id/progress - ユーザーの進捗取得
PUT    /api/lessons/:id/progress - 進捗更新
POST   /api/lessons/:id/complete - レッスン完了
```

### 3.3 練習ログエンドポイント

```
GET    /api/practice-logs      - ログ一覧（フィルター、ページネーション）
GET    /api/practice-logs/:id  - ログ詳細
POST   /api/practice-logs      - ログ作成
PUT    /api/practice-logs/:id  - ログ更新
DELETE /api/practice-logs/:id  - ログ削除
GET    /api/practice-logs/stats - 統計情報
```

### 3.4 音楽理論エンドポイント

```
GET    /api/scales             - スケール一覧
GET    /api/scales/:id         - スケール詳細
GET    /api/chords             - コード一覧
GET    /api/chords/:id         - コード詳細
GET    /api/chords/progression - コード進行生成
```

### 3.5 ソングライブラリエンドポイント

```
GET    /api/songs              - 楽曲一覧（検索、フィルター）
GET    /api/songs/:id          - 楽曲詳細
GET    /api/songs/:id/tab      - タブ譜取得
GET    /api/songs/:id/audio    - 音声ファイル取得
```

### 3.6 目標管理エンドポイント

```
GET    /api/goals              - 目標一覧
GET    /api/goals/:id          - 目標詳細
POST   /api/goals              - 目標作成
PUT    /api/goals/:id          - 目標更新
DELETE /api/goals/:id          - 目標削除
```

### 3.7 レスポンス形式

```typescript
// 成功レスポンス
{
  "success": true,
  "data": { ... },
  "message"?: string
}

// エラーレスポンス
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Error message",
    "details"?: { ... }
  }
}
```

---

## 4. 音声処理仕様

### 4.1 チューナー機能

#### Web実装（Tone.js + Web Audio API）
```typescript
// 音程検出アルゴリズム
1. マイク入力取得（getUserMedia）
2. AudioContextで音声ストリーム処理
3. FFT（Fast Fourier Transform）で周波数解析
4. ピーク周波数を検出
5. 周波数→音名変換（A4 = 440Hz基準）
6. セント単位で精度計算
7. 視覚的フィードバック表示
```

#### モバイル実装
- **iOS**: AVFoundation（AVAudioEngine）
- **Android**: AudioRecord + FFT
- React Nativeブリッジ経由でネイティブモジュール呼び出し

### 4.2 メトロノーム機能

```typescript
// Tone.js使用
const metronome = new Tone.Sequence((time, note) => {
  // クリック音生成
  const click = new Tone.Oscillator({
    frequency: note === 0 ? 800 : 400, // アクセント
    type: 'sine'
  }).toDestination();
  
  click.start(time);
  click.stop(time + 0.1);
}, [0, 1, 2, 3], '4n'); // 4/4拍子

metronome.start();
```

### 4.3 バッキングトラック

```typescript
// ドラムパターン生成
- プリセットパターン（JSON形式）
- 各楽器（キック、スネア、ハイハット）のタイミング定義
- Tone.jsのSequenceで再生
- ループ機能
- BPM調整
```

---

## 5. タブ譜システム

### 5.1 データ形式

```typescript
// VexFlow形式（JSON）
interface TabData {
  measures: Measure[];
}

interface Measure {
  timeSignature: [number, number]; // [4, 4]
  notes: Note[];
}

interface Note {
  string: number;      // 1-6
  fret: number;        // 0-24
  duration: string;    // "4n", "8n", etc.
  tie?: boolean;
}
```

### 5.2 レンダリング

```typescript
// VexFlow使用
import { Renderer, Stave, StaveNote, Voice, Formatter } from 'vexflow';

// タブ譜レンダリング
const renderer = new Renderer(div, Renderer.Backends.SVG);
const ctx = renderer.getContext();
const stave = new Stave(10, 10, 400);
stave.addClef('tab');
stave.setContext(ctx).draw();
```

### 5.3 再生機能

```typescript
// MIDI連携またはTone.js
- タブ譜データ→MIDIノート変換
- Tone.jsのSequenceで再生
- 速度調整（0.5x - 2.0x）
- ループ機能
```

---

## 6. スケール・コードビューアー

### 6.1 指板図レンダリング

```typescript
// SVGまたはCanvasで描画
interface Fretboard {
  strings: number;      // 6
  frets: number;       // 12-24
  tuning: string[];    // ["E", "A", "D", "G", "B", "E"]
}

interface ScalePosition {
  string: number;
  fret: number;
  note: string;
  root?: boolean;
}
```

### 6.2 インタラクティブ機能

- タップ/クリックで音を再生
- スケールタイプ切り替え
- キー変更
- ルート音のハイライト

---

## 7. パフォーマンス最適化

### 7.1 フロントエンド
- **コード分割**: Next.jsの動的インポート
- **画像最適化**: Next.js Imageコンポーネント
- **キャッシング**: React Query / SWR
- **バンドルサイズ**: Tree shaking、不要なライブラリ削除

### 7.2 バックエンド
- **データベース**: インデックス最適化、クエリ最適化
- **キャッシング**: Redis（頻繁にアクセスされるデータ）
- **CDN**: 静的アセット（画像、動画）
- **API**: レスポンス圧縮（gzip）

### 7.3 モバイル
- **オフライン機能**: SQLiteでローカルキャッシュ
- **画像最適化**: 解像度調整、遅延読み込み
- **バッテリー**: バックグラウンド処理の最適化

---

## 8. セキュリティ

### 8.1 認証・認可
- JWTトークン（NextAuth.js）
- パスワードハッシュ（bcrypt）
- CSRF保護
- レート制限

### 8.2 データ保護
- HTTPS必須
- SQLインジェクション対策（Prisma使用）
- XSS対策（Reactの自動エスケープ）
- 入力検証（Zod）

### 8.3 ファイルアップロード
- ファイルタイプ検証
- ファイルサイズ制限
- ウイルススキャン（オプション）

---

## 9. 監視・ログ

### 9.1 エラートラッキング
- Sentry（エラー監視）
- ログ集約（Winston + CloudWatch）

### 9.2 パフォーマンス監視
- Web Vitals（Next.js）
- API応答時間
- データベースクエリ時間

### 9.3 アナリティクス
- Google Analytics（オプション）
- カスタムイベント追跡

---

## 10. デプロイメント

### 10.1 Webアプリ
- **ホスティング**: Vercel（推奨）
- **環境変数**: Vercel環境変数管理
- **データベース**: AWS RDS または Supabase
- **ストレージ**: AWS S3 または Cloudinary

### 10.2 モバイルアプリ
- **ビルド**: 
  - iOS: Xcode Cloud または GitHub Actions
  - Android: GitHub Actions
- **配布**: 
  - iOS: TestFlight → App Store
  - Android: 内部テスト → 本番

---

この技術仕様書は、開発の進行に応じて更新していきます。

